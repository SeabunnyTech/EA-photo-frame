<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>能源轉型互動遊趣味特效相框 | Energy Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
            background: linear-gradient(180deg, #E8F5E9 0%, #C8E6C9 50%, #A5D6A7 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            position: relative;
            overflow-x: hidden;
        }

        /* 背景裝飾 */
        .bg-decor {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 300'%3E%3Cpath d='M0,300 Q50,250 30,200 Q10,150 40,100 Q60,60 50,0 L0,0 Z' fill='%234A7C5915'/%3E%3Cpath d='M100,300 Q120,280 110,250 Q90,220 120,180 Q150,140 130,100 Q110,60 140,20 L100,300 Z' fill='%234A7C5910'/%3E%3Cpath d='M700,300 Q680,260 710,220 Q740,180 700,140 Q660,100 700,50 L800,50 L800,300 Z' fill='%234A7C5915'/%3E%3Cpath d='M750,300 Q770,270 750,230 Q730,190 760,150 Q790,110 770,70 L800,70 L800,300 Z' fill='%234A7C5910'/%3E%3C/svg%3E") no-repeat bottom center;
            background-size: cover;
            pointer-events: none;
            opacity: 0.6;
        }

        /* Logo 區域 */
        .logo-section {
            text-align: center;
            margin-bottom: 1.5rem;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
        }

        .logo-icon svg {
            width: 100%;
            height: 100%;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2E7D32;
            letter-spacing: 2px;
        }

        .logo-text span {
            display: block;
            font-size: 0.75rem;
            font-weight: 400;
            letter-spacing: 1px;
            color: #4A7C59;
        }

        /* 標題 */
        .title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2E7D32;
            margin-bottom: 1.5rem;
            text-align: center;
            z-index: 10;
        }

        /* 照片框容器 */
        .frame-container {
            position: relative;
            width: 100%;
            max-width: 360px;
            aspect-ratio: 3/4;
            margin-bottom: 1.5rem;
            z-index: 10;
        }

        .photo-frame {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            overflow: hidden;
            background: #1a1a1a;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            cursor: pointer;
        }

        /* 預設上傳提示 */
        .upload-prompt {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            color: #666;
            transition: opacity 0.3s;
            z-index: 1;
        }

        .upload-prompt.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .upload-prompt svg {
            width: 60px;
            height: 60px;
            fill: #999;
            margin-bottom: 1rem;
        }

        .upload-prompt p {
            font-size: 1rem;
            color: #666;
        }

        /* Canvas 預覽 - 用戶照片在底層 */
        #previewCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 2;
        }

        /* PNG 圖框覆蓋層 - 在最上層 */
        .frame-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            background-image: url('frames/taiwan_buildings.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 隱藏的文件輸入 */
        #fileInput {
            display: none;
        }

        /* 按鈕區域 */
        .buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
            max-width: 280px;
            z-index: 10;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: 'Noto Sans TC', sans-serif;
            transition: all 0.3s ease;
        }

        .btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .btn-share {
            background: #E65100;
            color: white;
            box-shadow: 0 4px 15px rgba(230, 81, 0, 0.3);
        }

        .btn-share:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .btn-share:disabled {
            background: #ccc;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        .btn-retake {
            background: rgba(255, 255, 255, 0.7);
            color: #555;
            backdrop-filter: blur(10px);
        }

        .btn-retake:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        /* Toast 通知 */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            font-size: 0.9rem;
            z-index: 100;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 分享選單 */
        .share-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
        }

        .share-menu.show {
            transform: translateY(0);
        }

        .share-menu-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .share-menu-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }

        .share-menu h3 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #333;
            font-size: 1.1rem;
        }

        .share-options {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .share-option:hover {
            transform: scale(1.1);
        }

        .share-option-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .share-option-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .share-option span {
            font-size: 0.8rem;
            color: #666;
        }

        .share-option.facebook .share-option-icon { background: #1877F2; }
        .share-option.twitter .share-option-icon { background: #000; }
        .share-option.line .share-option-icon { background: #00B900; }
        .share-option.download .share-option-icon { background: #666; }

        .share-menu-close {
            width: 100%;
            padding: 1rem;
            border: none;
            background: #f5f5f5;
            border-radius: 12px;
            font-size: 1rem;
            color: #666;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* 相框切換按鈕 */
        .frame-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .frame-nav-btn:hover {
            background: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-50%) scale(1.1);
        }

        .frame-nav-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .frame-nav-btn svg {
            width: 24px;
            height: 24px;
            fill: #2E7D32;
        }

        .frame-nav-prev {
            left: -22px;
        }

        .frame-nav-next {
            right: -22px;
        }

        /* 響應式 */
        @media (max-height: 700px) {
            body {
                padding: 1rem;
            }
            .logo-section {
                margin-bottom: 1rem;
            }
            .title {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }
            .frame-container {
                max-width: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- 背景裝飾 -->
    <div class="bg-decor"></div>

    <!-- Logo -->
    <div class="logo-section">
        <div class="logo">
            <div class="logo-text">
                能源轉型互動遊趣味特效相框
                <span>Energy Quiz</span>
            </div>
        </div>
    </div>

    <!-- 標題 -->
    <h1 class="title">請選擇喜愛的相框模式</h1>

    <!-- 照片框 -->
    <div class="frame-container">
        <!-- 左側切換按鈕 -->
        <button class="frame-nav-btn frame-nav-prev" id="prevFrameBtn">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </button>
        <!-- 右側切換按鈕 -->
        <button class="frame-nav-btn frame-nav-next" id="nextFrameBtn">
            <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
        </button>
        <div class="photo-frame" id="photoFrame">
            <div class="upload-prompt" id="uploadPrompt">
                <svg viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                <p>點擊上傳照片</p>
            </div>
            <canvas id="previewCanvas"></canvas>
            <!-- PNG 圖框覆蓋層 -->
            <div class="frame-overlay" id="frameOverlay"></div>
        </div>
        <input type="file" id="fileInput" accept="image/*">
    </div>

    <!-- 按鈕 -->
    <div class="buttons">
        <button class="btn btn-share" id="shareBtn" disabled>
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            Share
        </button>
        <button class="btn btn-retake" id="retakeBtn">
            <svg viewBox="0 0 24 24"><path d="M9 12c0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3-3 1.34-3 3zm13.5-1c-.3-4.4-3.8-7.9-8.2-8.2V1h-2v1.8C7.9 3.1 4.4 6.6 4.1 11H3v2h1.1c.3 4.4 3.8 7.9 8.2 8.2V23h2v-1.8c4.4-.3 7.9-3.8 8.2-8.2H24v-2h-1.5zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
            Retake
        </button>
    </div>

    <!-- 分享選單 -->
    <div class="share-menu-backdrop" id="shareBackdrop"></div>
    <div class="share-menu" id="shareMenu">
        <h3>分享到社群</h3>
        <div class="share-options">
            <div class="share-option download" id="downloadOption">
                <div class="share-option-icon">
                    <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                </div>
                <span>下載</span>
            </div>
            <div class="share-option facebook" id="facebookOption">
                <div class="share-option-icon">
                    <svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                </div>
                <span>Facebook</span>
            </div>
            <div class="share-option twitter" id="twitterOption">
                <div class="share-option-icon">
                    <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </div>
                <span>X</span>
            </div>
            <div class="share-option line" id="lineOption">
                <div class="share-option-icon">
                    <svg viewBox="0 0 24 24"><path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg>
                </div>
                <span>LINE</span>
            </div>
        </div>
        <button class="share-menu-close" id="closeShareMenu">取消</button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // 可用的相框列表
        const frameList = [
            'frames/台灣四島-1.png',
            'frames/台灣特有生物-1.png',
            'frames/台灣特色建築-1.png',
            'frames/生態與綠能城市-1.png',
            'frames/光電與風電-1.png',
            'frames/地熱發電-1.png',
            'frames/水力發電(石門水庫)-1.png',
            'frames/陸域風電-1.png',
            'frames/綠色城市-1.png',
            'frames/離案風電與氫能-1.png'
        ];
        let currentFrameIndex = 0;

        // 狀態
        const state = {
            uploadedImage: null,
            frameImage: null,
            scale: 1,
            offsetX: 0,
            offsetY: 0,
            isDragging: false,
            lastX: 0,
            lastY: 0
        };

        // DOM 元素
        const photoFrame = document.getElementById('photoFrame');
        const fileInput = document.getElementById('fileInput');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const previewCanvas = document.getElementById('previewCanvas');
        const frameOverlay = document.getElementById('frameOverlay');
        const shareBtn = document.getElementById('shareBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const shareMenu = document.getElementById('shareMenu');
        const shareBackdrop = document.getElementById('shareBackdrop');
        const toast = document.getElementById('toast');
        const prevFrameBtn = document.getElementById('prevFrameBtn');
        const nextFrameBtn = document.getElementById('nextFrameBtn');

        // 載入指定圖框
        function loadFrame(frameSrc) {
            const img = new Image();
            img.onload = () => {
                state.frameImage = img;
                frameOverlay.style.backgroundImage = `url('${frameSrc}')`;
            };
            img.src = frameSrc;
        }

        // 初始化 - 載入預設圖框
        function initFrame() {
            loadFrame(frameList[currentFrameIndex]);
        }
        initFrame();

        // 切換到上一個相框
        function prevFrame() {
            currentFrameIndex = (currentFrameIndex - 1 + frameList.length) % frameList.length;
            loadFrame(frameList[currentFrameIndex]);
        }

        // 切換到下一個相框
        function nextFrame() {
            currentFrameIndex = (currentFrameIndex + 1) % frameList.length;
            loadFrame(frameList[currentFrameIndex]);
        }

        // 相框切換按鈕事件
        prevFrameBtn.addEventListener('click', prevFrame);
        nextFrameBtn.addEventListener('click', nextFrame);

        // 點擊上傳照片
        photoFrame.addEventListener('click', (e) => {
            if (!state.uploadedImage) {
                fileInput.click();
            }
        });

        // 文件選擇 - 用戶照片
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handlePhotoUpload(file);
        });

        // 處理照片上傳
        function handlePhotoUpload(file) {
            if (!file.type.startsWith('image/')) {
                showToast('請上傳圖片文件');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    state.uploadedImage = img;
                    state.scale = 1;
                    state.offsetX = 0;
                    state.offsetY = 0;
                    renderPreview();
                    uploadPrompt.classList.add('hidden');
                    shareBtn.disabled = false;
                    showToast('照片上傳成功！');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 渲染預覽
        function renderPreview() {
            if (!state.uploadedImage) return;

            const canvas = previewCanvas;
            const ctx = canvas.getContext('2d');

            // 設定畫布尺寸（3:4 比例）
            canvas.width = 600;
            canvas.height = 800;

            const img = state.uploadedImage;

            // 計算填滿畫布的縮放
            const canvasRatio = canvas.width / canvas.height;
            const imgRatio = img.width / img.height;

            let drawWidth, drawHeight;
            if (imgRatio > canvasRatio) {
                drawHeight = canvas.height * state.scale;
                drawWidth = drawHeight * imgRatio;
            } else {
                drawWidth = canvas.width * state.scale;
                drawHeight = drawWidth / imgRatio;
            }

            const x = (canvas.width - drawWidth) / 2 + state.offsetX;
            const y = (canvas.height - drawHeight) / 2 + state.offsetY;

            // 清除並繪製
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, x, y, drawWidth, drawHeight);
        }

        // 觸控/滑鼠拖曳調整位置
        let touchStartDist = 0;
        let initialScale = 1;

        previewCanvas.addEventListener('mousedown', startDrag);
        previewCanvas.addEventListener('mousemove', drag);
        previewCanvas.addEventListener('mouseup', endDrag);
        previewCanvas.addEventListener('mouseleave', endDrag);

        previewCanvas.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                touchStartDist = getTouchDistance(e.touches);
                initialScale = state.scale;
            } else {
                startDrag(e.touches[0]);
            }
        });

        previewCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length === 2) {
                const dist = getTouchDistance(e.touches);
                state.scale = Math.max(0.5, Math.min(3, initialScale * (dist / touchStartDist)));
                renderPreview();
            } else {
                drag(e.touches[0]);
            }
        });

        previewCanvas.addEventListener('touchend', endDrag);

        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function startDrag(e) {
            if (!state.uploadedImage) return;
            state.isDragging = true;
            state.lastX = e.clientX || e.pageX;
            state.lastY = e.clientY || e.pageY;
        }

        function drag(e) {
            if (!state.isDragging) return;
            const x = e.clientX || e.pageX;
            const y = e.clientY || e.pageY;

            state.offsetX += (x - state.lastX) * 2;
            state.offsetY += (y - state.lastY) * 2;

            state.lastX = x;
            state.lastY = y;
            renderPreview();
        }

        function endDrag() {
            state.isDragging = false;
        }

        // 滾輪縮放
        previewCanvas.addEventListener('wheel', (e) => {
            if (!state.uploadedImage) return;
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.95 : 1.05;
            state.scale = Math.max(0.5, Math.min(3, state.scale * delta));
            renderPreview();
        });

        // 重拍按鈕
        retakeBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // 分享按鈕
        shareBtn.addEventListener('click', () => {
            shareMenu.classList.add('show');
            shareBackdrop.classList.add('show');
        });

        // 關閉分享選單
        document.getElementById('closeShareMenu').addEventListener('click', closeShareMenu);
        shareBackdrop.addEventListener('click', closeShareMenu);

        function closeShareMenu() {
            shareMenu.classList.remove('show');
            shareBackdrop.classList.remove('show');
        }

        // 生成最終圖片（合成用戶照片 + 圖框）
        function generateFinalImage() {
            return new Promise((resolve) => {
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = 600;
                finalCanvas.height = 800;
                const ctx = finalCanvas.getContext('2d');

                // 1. 先繪製用戶照片
                ctx.drawImage(previewCanvas, 0, 0);

                // 2. 再繪製圖框（如果有的話）
                if (state.frameImage) {
                    ctx.drawImage(state.frameImage, 0, 0, 600, 800);
                }

                resolve(finalCanvas.toDataURL('image/png'));
            });
        }

        // 下載
        document.getElementById('downloadOption').addEventListener('click', async () => {
            const dataUrl = await generateFinalImage();
            const link = document.createElement('a');
            link.download = `Energy_Quiz_${Date.now()}.png`;
            link.href = dataUrl;
            link.click();
            showToast('照片已下載！');
            closeShareMenu();
        });

        // 社群分享
        async function shareToSocial(platform) {
            const dataUrl = await generateFinalImage();
            const shareText = '我在 Energy Quiz 創建了專屬照片框！一起支持能源轉型！ #EnergyQuiz #能源轉型';
            const shareUrl = window.location.href;

            // 嘗試 Web Share API
            if (navigator.share) {
                try {
                    const response = await fetch(dataUrl);
                    const blob = await response.blob();
                    const file = new File([blob], 'energy-quiz.png', { type: 'image/png' });

                    await navigator.share({
                        title: 'Energy Quiz',
                        text: shareText,
                        files: [file]
                    });
                    closeShareMenu();
                    return;
                } catch (err) {
                    console.log('Web Share failed:', err);
                }
            }

            // 備用：開啟社群網站
            let url;
            const encodedText = encodeURIComponent(shareText);
            const encodedUrl = encodeURIComponent(shareUrl);

            switch (platform) {
                case 'facebook':
                    url = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}`;
                    break;
                case 'twitter':
                    url = `https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}`;
                    break;
                case 'line':
                    url = `https://social-plugins.line.me/lineit/share?url=${encodedUrl}&text=${encodedText}`;
                    break;
            }

            if (url) {
                window.open(url, '_blank', 'width=600,height=400');
                showToast('請先下載圖片，再手動上傳分享');
            }
            closeShareMenu();
        }

        document.getElementById('facebookOption').addEventListener('click', () => shareToSocial('facebook'));
        document.getElementById('twitterOption').addEventListener('click', () => shareToSocial('twitter'));
        document.getElementById('lineOption').addEventListener('click', () => shareToSocial('line'));

        // Toast
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
